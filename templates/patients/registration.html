<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% if edit_mode %}Edit Patient{% else %}Patient Registration{% endif %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#f7f7fb}.card{border:0;box-shadow:0 1px 2px rgba(0,0,0,.05),0 4px 16px rgba(0,0,0,.04)}</style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="h5 mb-3">{% if edit_mode %}Edit Patient{% else %}Patient Registration{% endif %}</h1>

  <form method="post" class="card">
    <div class="card-body">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}

      <!-- Identity -->
      <h2 class="h6">Identity</h2>
<div class="row g-2"><div class="col-md-6">
<label class="form-label">Specialty</label>{{ form.specialty }}
</div></div>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">First Name *</label>
          {{ form.first_name }} {{ form.first_name.errors }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Middle</label>
          {{ form.middle_name }} {{ form.middle_name.errors }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Last Name *</label>
          {{ form.last_name }} {{ form.last_name.errors }}
        </div>
        <div class="col-md-3">
          <label class="form-label">DOB</label>
          {{ form.dob }} {{ form.dob.errors }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Gender</label>
          {{ form.gender }} {{ form.gender.errors }}
        </div>
        <div class="col-md-3">
          <label class="form-label">SSN</label>
          {{ form.ssn }} {{ form.ssn.errors }}
        </div>
      
      <div id="spec_fields" class="mt-3"></div>

      <!-- Contact -->
      <h2 class="h6 mt-3">Contact</h2>
      <div class="row g-2">
        <div class="col-md-3"><label class="form-label">Phone</label>{{ form.phone }} {{ form.phone.errors }}</div>
        <div class="col-md-3"><label class="form-label">Alt Phone</label>{{ form.phone_alt }} {{ form.phone_alt.errors }}</div>
        <div class="col-md-6"><label class="form-label">Email</label>{{ form.email }} {{ form.email.errors }}</div>
      </div>

      <!-- Address -->
      <h2 class="h6 mt-3">Address</h2>
      <div class="row g-2">
        <div class="col-md-6"><label class="form-label">Address line 1</label>{{ form.address_line1 }} {{ form.address_line1.errors }}</div>
        <div class="col-md-6"><label class="form-label">Address line 2</label>{{ form.address_line2 }} {{ form.address_line2.errors }}</div>
        <div class="col-md-3"><label class="form-label">City</label>{{ form.city }} {{ form.city.errors }}</div>
        <div class="col-md-3"><label class="form-label">State</label>{{ form.state }} {{ form.state.errors }}</div>
        <div class="col-md-3"><label class="form-label">ZIP</label>{{ form.postal_code }} {{ form.postal_code.errors }}</div>
        <div class="col-md-3"><label class="form-label">Country</label>{{ form.country }} {{ form.country.errors }}</div>
      </div>

      <!-- Demographics -->
      <h2 class="h6 mt-3">Demographics</h2>
      <div class="row g-2">
        <div class="col-md-3"><label class="form-label">Race</label>{{ form.race }} {{ form.race.errors }}</div>
        <div class="col-md-3"><label class="form-label">Ethnicity</label>{{ form.ethnicity }} {{ form.ethnicity.errors }}</div>
        <div class="col-md-3"><label class="form-label">Language</label>{{ form.language }} {{ form.language.errors }}</div>
        <div class="col-md-3"><label class="form-label">Marital</label>{{ form.marital_status }} {{ form.marital_status.errors }}</div>
        <div class="col-md-4"><label class="form-label">Preferred contact</label>{{ form.preferred_contact_method }} {{ form.preferred_contact_method.errors }}</div>
      </div>

      <!-- Employment / Guarantor -->
      <h2 class="h6 mt-3">Employment / Guarantor</h2>
      <div class="row g-2">
        <div class="col-md-4"><label class="form-label">Employer</label>{{ form.employer_name }} {{ form.employer_name.errors }}</div>
        <div class="col-md-4"><label class="form-label">Occupation</label>{{ form.occupation }} {{ form.occupation.errors }}</div>
        <div class="col-md-4"><label class="form-label">Guarantor Name</label>{{ form.guarantor_name }} {{ form.guarantor_name.errors }}</div>
        <div class="col-md-4"><label class="form-label">Guarantor Relationship</label>{{ form.guarantor_relationship }} {{ form.guarantor_relationship.errors }}</div>
        <div class="col-md-4"><label class="form-label">Guarantor Phone</label>{{ form.guarantor_phone }} {{ form.guarantor_phone.errors }}</div>
      </div>

      <!-- Emergency Contact (custom fields outside ModelForm) -->
      <h2 class="h6 mt-3">Emergency Contact</h2>
      <div class="row g-2">
        <div class="col-md-4"><label class="form-label">Name</label><input name="ec_name" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Relationship</label><input name="ec_relationship" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Phone</label><input name="ec_phone" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">Email</label><input name="ec_email" class="form-control"></div>
      </div>

      <!-- Primary Coverage -->
      <h2 class="h6 mt-3">Primary Coverage (optional)</h2>
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Payer (search)</label>
          <div class="input-group">
            <input id="payer_q" class="form-control" placeholder="Type payer name">
            <button class="btn btn-outline-secondary" type="button" onclick="searchPayers()">Search</button>
          </div>
          <div id="payer_results" class="list-group small mt-1"></div>
          <input type="hidden" name="payer_id" id="payer_id">
        </div>
        <div class="col-md-6"><label class="form-label">Plan Name</label><input name="plan_name" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Member ID</label><input name="member_id" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Group #</label><input name="group_number" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Relationship</label><input name="cov_relationship" class="form-control" value="self"></div>
        <div class="col-md-3"><label class="form-label">Eff. Start</label><input name="effective_start" class="form-control" placeholder="YYYY-MM-DD"></div>
        <div class="col-md-3"><label class="form-label">Eff. End</label><input name="effective_end" class="form-control" placeholder="YYYY-MM-DD"></div>
        <div class="col-12"><small class="text-muted">Rx card (if provided):</small></div>
        <div class="col-md-3"><label class="form-label">Rx BIN</label><input name="rx_bin" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Rx PCN</label><input name="rx_pcn" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Rx Group</label><input name="rx_group" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Rx ID</label><input name="rx_id" class="form-control"></div>
      </div>

      <!-- Secondary Coverage -->
      <h2 class="h6 mt-4">Secondary Coverage (optional)</h2>
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Payer (search)</label>
          <div class="input-group">
            <input id="sec_payer_q" class="form-control" placeholder="Type payer name">
            <button class="btn btn-outline-secondary" type="button" onclick="searchPayersSec()">Search</button>
          </div>
          <div id="sec_payer_results" class="list-group small mt-1"></div>
          <input type="hidden" name="sec_payer_id" id="sec_payer_id">
        </div>
        <div class="col-md-6"><label class="form-label">Plan Name</label><input name="sec_plan_name" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Member ID</label><input name="sec_member_id" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Group #</label><input name="sec_group_number" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Relationship</label><input name="sec_relationship" class="form-control" value="self"></div>

        <div class="col-12"><small class="text-muted">If subscriber â‰  patient, fill below:</small></div>
        <div class="col-md-6"><label class="form-label">Subscriber Name</label><input name="sec_subscriber_name" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Subscriber DOB</label><input name="sec_subscriber_dob" class="form-control" placeholder="YYYY-MM-DD"></div>
        <div class="col-md-3"><label class="form-label">Subscriber Phone</label><input name="sec_subscriber_phone" class="form-control"></div>

        <div class="col-12"><small class="text-muted">Rx card (if provided):</small></div>
        <div class="col-md-3"><label class="form-label">Rx BIN</label><input name="sec_rx_bin" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Rx PCN</label><input name="sec_rx_pcn" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Rx Group</label><input name="sec_rx_group" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Rx ID</label><input name="sec_rx_id" class="form-control"></div>

        <div class="col-md-3"><label class="form-label">Eff. Start</label><input name="sec_effective_start" class="form-control" placeholder="YYYY-MM-DD"></div>
        <div class="col-md-3"><label class="form-label">Eff. End</label><input name="sec_effective_end" class="form-control" placeholder="YYYY-MM-DD"></div>
      </div>

      <h2 class="h6 mt-3">Consents / Portal</h2>
      <div class="form-check"><input class="form-check-input" type="checkbox" name="portal_enrolled" id="portal_enrolled"><label class="form-check-label" for="portal_enrolled">Enroll in portal</label></div>
      <div class="form-check"><input class="form-check-input" type="checkbox" name="consent_to_treat" id="consent_to_treat"><label class="form-check-label" for="consent_to_treat">Consent to treat</label></div>
      <div class="form-check"><input class="form-check-input" type="checkbox" name="assignment_of_benefits" id="assignment_of_benefits"><label class="form-check-label" for="assignment_of_benefits">Assignment of benefits</label></div>
      <div class="form-check mb-3"><input class="form-check-input" type="checkbox" name="hipaa_privacy_ack" id="hipaa_privacy_ack"><label class="form-check-label" for="hipaa_privacy_ack">HIPAA privacy acknowledgment</label></div>

      <div class="mt-3">
        <button class="btn btn-primary">{% if edit_mode %}Save Changes{% else %}Create Patient{% endif %}</button>
        {% if edit_mode %}
          <a class="btn btn-secondary ms-2" href="/registry/patient/{{patient_id}}/">Cancel</a>
        {% else %}
          <a class="btn btn-secondary ms-2" href="/">Cancel</a>
        {% endif %}
      </div>
    </div>
  </form>
</div>

<script>
function searchPayers(){
  const q = document.getElementById('payer_q').value.trim();
  if(!q){ return; }
  fetch('/registry/payers/search_json/?q='+encodeURIComponent(q))
    .then(r=>r.json()).then(d=>{
      const list = document.getElementById('payer_results'); list.innerHTML='';
      (d.results||[]).forEach(item=>{
        const a=document.createElement('a'); a.href='#'; a.className='list-group-item list-group-item-action';
        a.textContent=item.label;
        a.onclick=(ev)=>{ev.preventDefault(); document.getElementById('payer_id').value=item.id; document.getElementById('payer_q').value=item.label; list.innerHTML='';};
        list.appendChild(a);
      });
    }).catch(()=>{});
}
function searchPayersSec(){
  const q = document.getElementById('sec_payer_q').value.trim();
  if(!q){ return; }
  fetch('/registry/payers/search_json/?q='+encodeURIComponent(q))
    .then(r=>r.json()).then(d=>{
      const list = document.getElementById('sec_payer_results'); list.innerHTML='';
      (d.results||[]).forEach(item=>{
        const a=document.createElement('a'); a.href='#'; a.className='list-group-item list-group-item-action';
        a.textContent=item.label;
        a.onclick=(ev)=>{ev.preventDefault(); document.getElementById('sec_payer_id').value=item.id; document.getElementById('sec_payer_q').value=item.label; list.innerHTML='';};
        list.appendChild(a);
      });
    }).catch(()=>{});
}
</script>
</body>
</html>

<script>
function asEl(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function renderFields(fields, existing){
  const box = document.getElementById('spec_fields');
  box.innerHTML = '';
  if(!fields || !fields.length){ return; }
  const groups = {};
  fields.forEach(f=>{ groups[f.group||'Other'] = groups[f.group||'Other'] || []; groups[f.group||'Other'].push(f); });
  for(const g of Object.keys(groups)){
    const card = asEl('<div class="card mb-2"><div class="card-body"><h3 class="h6 mb-2">'+g+'</h3><div class="row g-2"></div></div></div>');
    const row = card.querySelector('.row');
    groups[g].sort((a,b)=> (a.order||100)-(b.order||100));
    groups[g].forEach(f=>{
      const name = 'spec_'+f.key;
      let control = '';
      const val = existing && existing[name] ? existing[name] : '';
      if(f.type==='textarea'){ control = '<textarea class="form-control" name="'+name+'">'+(val||'')+'</textarea>'; }
      else if(f.type==='select'){
        const opts = (f.choices||[]).map(c=>'<option value="'+c.value+'" '+(c.value==val?'selected':'')+'>'+c.label+'</option>').join('');
        control = '<select class="form-select" name="'+name+'"><option value=""></option>'+opts+'</select>';
      } else if(f.type==='checkbox'){
        control = '<input type="checkbox" class="form-check-input" name="'+name+'" '+(val?'checked':'')+'>';
      } else if(f.type==='date'){ control = '<input type="date" class="form-control" name="'+name+'" value="'+(val||'')+'">'; }
      else if(f.type==='number'){ control = '<input type="number" step="any" class="form-control" name="'+name+'" value="'+(val||'')+'">'; }
      else if(f.type==='email'){ control = '<input type="email" class="form-control" name="'+name+'" value="'+(val||'')+'">'; }
      else if(f.type==='phone'){ control = '<input type="tel" class="form-control" name="'+name+'" value="'+(val||'')+'">'; }
      else { control = '<input type="text" class="form-control" name="'+name+'" value="'+(val||'')+'">'; }
      const col = asEl('<div class="col-md-6"><label class="form-label">'+f.label+(f.required?' *':'')+'</label>'+control+'<small class="text-muted">'+(f.help||'')+'</small></div>');
      row.appendChild(col);
    });
    box.appendChild(card);
  }
}

async function loadSpecialtyFields(){
  const sel = document.querySelector('select[name="specialty"]');
  const val = sel ? sel.value : '';
  if(!val){ renderFields([]); return; }
  const r = await fetch('/specialties/fields.json?specialty_id='+encodeURIComponent(val));
  const j = await r.json();
  renderFields(j.items, window._specExisting || {});
}

document.addEventListener('DOMContentLoaded', ()=>{
  const sel = document.querySelector('select[name="specialty"]');
  if(sel){ sel.addEventListener('change', loadSpecialtyFields); }
  // existing values on edit
  window._specExisting = {};
  {% if edit_mode and form.instance and form.instance.extra_json %}
    {% with sf=form.instance.extra_json.specialty_fields %}
      window._specExisting = {{ sf|default:"{}"|safe }};
    {% endwith %}
  {% endif %}
  loadSpecialtyFields();
});
</script>
